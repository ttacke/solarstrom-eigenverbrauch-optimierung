<html>
<head>
	<title>Solarstrom Eigenverbrauch Optimierung</title>
	<script type="text/javascript">
		const wochentage = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
		var ist_initialisiert = false;

		function refresh() {
			if(!ist_initialisiert) {
				window.warte_auf_daten = false;
				_erstelle_wettertabelle('solarstrahlung', 18);
				_erstelle_wettertabelle('wetter_stunden', 12);//DEPRECATED
				_erstelle_wettertabelle('wetter_tage', 5);//DEPRECATED
				setInterval(refresh, 1000 * 60);
				ist_initialisiert = true;
			}
			if(!window.warte_auf_daten) {// Verhindern, dass sich Requests stauen, ueberholen etc
				_lies_daten(function() {
					window.warte_auf_daten = false;
				});
			}
		}
		function _setze_daten_ein(daten) {
			_setze_wetter_stunden_label('solarstrahlung', 0, 12, daten);
			_setze_wetter_stunden_label('wetter_stunden', 0, 12, daten);// DEPRECATED
			_setze_wetter_daten(daten['solarstrahlung_stunden_in_prozent'], 'wetter_stunden');
			_setze_wetter_tage_label('solarstrahlung', 13, 5, daten);
			_setze_wetter_tage_label('wetter_tage', 0, 5, daten);//DEPRECATED
			_setze_wetter_daten(daten['solarstrahlung_tage_in_prozent'], 'wetter_tage');
			_setze_elektrische_daten(daten);
			_setze_verbrauchshinweise(daten);

			document.getElementById('solaranteil_in_prozent_string1').innerHTML = daten['solaranteil_in_prozent_string1'];
			document.getElementById('solaranteil_in_prozent_string2').innerHTML = daten['solaranteil_in_prozent_string2'];
		}
		function _setze_verbrauchshinweise(daten) {
			var template = document.getElementById('verbrauchshinweise_template');
			var container = document.getElementById('verbrauchshinweise');
			container.innerHTML = '';
			for(var i = 0; i < daten['verbrauchshinweise'].length; i++) {
				var e = daten['verbrauchshinweise'][i];
				var ui = document.createElement('div');
				ui.innerHTML = template.innerHTML;

				var leistung = Math.round(e['leistung_in_w'] / 100);
				if(leistung < 10) {
					leistung = "0" + leistung;
				} else {
					leistung += "";
				}
				leistung = leistung.replace(/^([\-+]?\d+)(\d)$/, "$1.$2");
				ui.getElementsByClassName('leistung')[0].innerHTML = leistung;

				ui.getElementsByClassName('start')[0].innerHTML = new Date(e['start'] * 1000).getHours();

				ui.getElementsByClassName('stop')[0].innerHTML = new Date(e['stop'] * 1000).getHours();

				container.appendChild(ui);
			}
		}
		function _zaehle_fehler(fehler_vorhanden) {
			if(fehler_vorhanden) {
				if(!window.zeit_des_ersten_fehlers) {
					window.zeit_des_ersten_fehlers = new Date().getTime();
				}
				document.getElementsByTagName('body')[0].className = "fehler";
				var minuten_seit_fehler = Math.round((new Date().getTime() - window.zeit_des_ersten_fehlers) / 1000 / 60);
				document.getElementById('fehler_seit').innerHTML = minuten_seit_fehler;
			} else {
				window.fehler_seit = null;
				document.getElementsByTagName('body')[0].className = "";
				window.zeit_des_ersten_fehlers = null;
			}
		}
		function _setze_wetter_stunden_label(id, offset, length, daten) {
			var table = document.getElementById(id);
			// "let" funktioniert im KindleBrowser nicht
			var t = new Date(daten['solarstrahlung_stunden_startzeit'] * 1000);
			var footer_cell = table.getElementsByTagName('tfoot')[0].getElementsByTagName('td');
			for(var i = offset; i < offset + length; i++) {
				if(daten['solarstrahlung_stunden_startzeit'] > 0) {
					footer_cell[i].innerHTML = t.getHours();
					t.setHours(t.getHours() + 1);
				} else {
					footer_cell[i].innerHTML = "-";
				}
			}
		}
		function _setze_wetter_tage_label(id, offset, length, daten) {
			var table = document.getElementById(id);
			var t = new Date(daten['solarstrahlung_tage_startzeit'] * 1000);
			var footer_cell = table.getElementsByTagName('tfoot')[0].getElementsByTagName('td');
			for(var i = offset; i < offset + length; i++) {
				if(daten['solarstrahlung_tage_startzeit'] > 0) {
					footer_cell[i].innerHTML = wochentage[t.getDay()];
					t.setDate(t.getDate() + 1);
				} else {
					footer_cell[i].innerHTML = "-";
				}
			}
		}
		function _setze_wetter_daten(vorhersagedaten, id) {
			var table = document.getElementById(id);
			var body_tr = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
			for(var zeile_nr = 0; zeile_nr < body_tr.length; zeile_nr++) {
				var schwelle = (10 - zeile_nr);// 10..1
				var td_list = body_tr[zeile_nr].getElementsByTagName('td');
				for(var spalte_nr = 0; spalte_nr < td_list.length; spalte_nr++) {
					if(vorhersagedaten[spalte_nr] / 10 >= schwelle) {
						td_list[spalte_nr].className = "on";
					} else {
						td_list[spalte_nr].className = "";
					}
				}
			}
		}
		function _setze_elektrische_daten(daten) {
			var ueberschuss_in_wh = (daten.ueberschuss_in_wh > 0 ? '+' : '') + daten.ueberschuss_in_wh;
			ueberschuss_in_wh = ueberschuss_in_wh.replace(/^([\-+]?\d+)(\d\d\d)$/, "$1.$2");
			document.getElementById("ueberschuss").innerHTML = ueberschuss_in_wh;
			if(daten.ueberschuss_in_wh < 0) {
				if(daten.solarakku_ist_an) {
					document.getElementById("elektrische_daten").className = "aus_dem_akku";
				} else {
					document.getElementById("elektrische_daten").className = "aus_dem_netz";
				}
			} else {
				document.getElementById("elektrische_daten").className = "";
			}
			var ladestand = "" + daten.solarakku_ladestand_in_promille;
			ladestand = ladestand.replace(/^(.+)(\d)$/, "$1.$2");
			document.getElementById("batterie_ladestand").innerHTML = ladestand;
		}
		function _lies_daten(done_func) {
			var xhr = new XMLHttpRequest();
			xhr.onreadystatechange = function(args) {
				if(this.readyState == this.DONE) {
					done_func();
					if(this.status == 200) {
						_setze_daten_ein(JSON.parse(this.responseText));
						_zaehle_fehler(false);
					} else {
						_zaehle_fehler(true);
					}
				}
			};
			xhr.ontimeout = function(args) {
				_zaehle_fehler(true);
				done_func();
			}
			xhr.open(
				'GET',
				'daten.json?time=' + Math.floor(new Date().getTime() / 1000),
				true
			);
			xhr.timeout = 30 * 1000;
			xhr.send();
		}
		function _erstelle_wettertabelle(id, cols) {
			var tabelle = document.getElementById(id);
			var children = [
				{el:document.createElement('thead'), rows:1, width:true},
				{el:document.createElement('tbody'), rows:10, width:false},
				{el:document.createElement('tfoot'), rows:1, width:false}
			];
			for(var i = 0; i < children.length; i++) {
				for(var ii = 0; ii < children[i].rows; ii++) {
					var tr = document.createElement("tr");
					for(var iii = 0; iii < cols; iii++) {
						tr.appendChild(document.createElement('td'));
					}
					children[i].el.appendChild(tr);
				}
				tabelle.appendChild(children[i].el);
			}
		}
	</script>
	<style>
		body {
			padding: 0.5rem;
		}
		/*transform:rotate(180deg); geht im Kindle nicht*/
		* {
			font-family: sans-serif;
			color: #000;
		}

		#fehler_vorhang {
			display: none;
			position: absolute;
			top: 0;
			left: 0;
			opacity: 0.2;
			background-color: white;
			width: 100%;
			height: 100%;
			z-index: 100;
		}
		#fehler {
			display: none;
			text-align: center;
			position: absolute;
			width: 100%;
			z-index: 101;
			font-size: 2rem;
		}

		body.fehler #fehler,
		body.fehler #fehler_vorhang {
			display: block;
		}


		#elektrische_daten {
			position: relative;
			font-weight: bold;
			white-space: nowrap;
			height: 4.5rem;
		}
		#elektrische_daten .energie {
			position: absolute;
			text-align: right;
			width: 70%;
			top: -30px;
		}
			#elektrische_daten.aus_dem_akku .energie,
			#elektrische_daten.aus_dem_netz .energie {
				width: 45%;
				top: 10px;
			}
		#elektrische_daten #ueberschuss {
			font-size: 5.0rem;
			text-align: right;
			vertical-align: center;
		}
			#elektrische_daten.aus_dem_akku #ueberschuss,
			#elektrische_daten.aus_dem_netz #ueberschuss {
				font-size: 2.3rem;
			}
		#elektrische_daten .batterie {
			position: absolute;
			right: 0;
			top: 15px;
		}
			#elektrische_daten.aus_dem_akku .batterie {
				top: -35px;
			}
			#elektrische_daten.aus_dem_netz .batterie {
			}
		#elektrische_daten #batterie_ladestand {
			font-size: 2.3rem;
			text-align: right;
			height: 3rem;
			vertical-align: center;
		}
			#elektrische_daten.aus_dem_akku #batterie_ladestand {
				font-size: 5.0rem;
			}
			#elektrische_daten.aus_dem_netz #batterie_ladestand {
			}
		#elektrische_daten .einheit {
			height: 3rem;
			font-size: 1.5rem;
		}


		.wetter {
			width: 100%;
			border-collapse: separate;
			border-spacing: 0.1rem 0.1rem;
			margin-top: 0.3rem;
		}
		.wetter thead td {
			border-bottom: solid 0.1rem black;
		}
		.wetter tfoot td {
			border-top: solid 0.1rem black;
		}
		.wetter tbody td {
			height: 0.5rem;
			background-color: #CCC;
		}
			.wetter#solarstrahlung thead td {
				width: 5.88%;
			}
			.wetter#solarstrahlung tr td:nth-child(13) {
				width: 1%;
				background-color: inherit;
				border: none;
			}
			
			#wetter_stunden tbody td {
				width: 8%;
			}
			#wetter_tage tbody td {
				width: 20%;
			}
		.wetter tbody td.on {
			background-color: #000 !important;
		}
		.wetter tfoot td {
			border-top: solid 0.1rem black;
			font-size: 1rem;
			font-weight: normal;
			text-align: center;
		}
		#verbrauchshinweise_template {
			display: none;
		}
		#verbrauchshinweise {
			margin-top: 0.2rem;
			text-align: center;
			font-size: 2.0rem;
		}
			#verbrauchshinweise .start,
			#verbrauchshinweise .stop,
			#verbrauchshinweise .leistung {
				font-weight: bold;
				font-size: 3.0rem;
			}
			#verbrauchshinweise .stop:after {
				content: "00";
				font-size: 0.5em;
				vertical-align: top;
			}
			#verbrauchshinweise .leistung:after {
				content: "kW";
				font-size: 0.5em;
			}
		.verteilung_hinweis {
			font-size: 0.8rem;
			text-align: center;
		}
		/*#steuerung {*/
		/*	padding-top: 0.8rem;*/
		/*	text-align: center;*/
		/*}*/
		/*	#steuerung button {*/
		/*		font-size: 2.5rem;*/
		/*		font-weight: bold;*/
		/*	}*/
		/*	#steuerung button.aktiv {*/
		/*		background-color: #000;*/
		/*		color: #FFF;*/
		/*	}*/
	</style>
</head>
<body onload="refresh();">

<div id="fehler_vorhang"></div>
<div id="fehler">
	<h1>FEHLER</h1>
	<p>Seit <span id="fehler_seit"></span> Minuten gab es keine Daten mehr.</p>

	<p>Einfach warten, was wird schon...</p>
</div>

<div id="elektrische_daten" onclick="refresh();">
	<div class="energie">
		<span id="ueberschuss"></span>
		<span class="einheit">W</span>
	</div>
	<div class="batterie">
		<span id="batterie_ladestand"></span>
		<span class="einheit">%</span>
	</div>
</div>

<div class="verteilung_hinweis">
	Nord-Ost = <span id="solaranteil_in_prozent_string1"></span>%,
	S&uumld-West = <span id="solaranteil_in_prozent_string2"></span>%
</div>

<table class="wetter" id="solarstrahlung"></table>

<table class="wetter" id="wetter_stunden"></table>

<table class="wetter" id="wetter_tage"></table>

<div id="verbrauchshinweise_template">
	&gt; <span class="leistung"></span>: von <span class="start"></span> - <span class="stop"></span>
</div>

<div id="verbrauchshinweise"></div>

<!--div id="steuerung">
	<button>Auto&nbsp;<span id="auto_ladestand">64%</span></button>
	<button class="aktiv">Wass</button>
	<button>Heiz</button>
</div-->

</body>
</html>
